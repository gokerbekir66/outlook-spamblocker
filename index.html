<!DOCTYPE html><html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Outlook SpamBlocker — HTML (Microsoft Graph)</title>
  <script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js" integrity="sha384-ZKz7hY2GJm7k1qv7yVfQp1b0E6Cj4pVb6G4H0yq2j6d4Q3r8BGLhWSQ0rjQj1rJc" crossorigin="anonymous"></script>
  <script>
    // Tailwind via CDN for quick styling
    // (Safe for a static demo; for production, pin a version and consider self-hosting.)
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Simple spinner */
    .spinner { border: 4px solid #e5e7eb; border-top: 4px solid #111827; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-5xl mx-auto p-4 sm:p-6">
    <header class="flex items-start sm:items-center justify-between gap-4 flex-col sm:flex-row">
      <div>
        <h1 class="text-2xl font-bold">Outlook SpamBlocker</h1>
        <p class="text-sm text-gray-600">HTML tek sayfa uygulama · Microsoft Graph + MSAL (PKCE) · <span id="version">v1.0</span></p>
      </div>
      <div class="flex gap-2 items-center">
        <button id="loginBtn" class="px-4 py-2 rounded-2xl bg-black text-white disabled:opacity-50">Oturum Aç</button>
        <button id="logoutBtn" class="px-4 py-2 rounded-2xl bg-gray-200" disabled>Çıkış</button>
      </div>
    </header><section class="mt-6 grid md:grid-cols-2 gap-4">
  <!-- Config Card -->
  <div class="bg-white rounded-2xl shadow p-4 sm:p-6">
    <h2 class="text-lg font-semibold mb-3">1) Kimlik & Yetkiler</h2>
    <div class="space-y-3">
      <label class="block text-sm">Microsoft Entra (Azure) <b>Client ID</b>
        <input id="clientId" class="mt-1 w-full px-3 py-2 border rounded-xl" placeholder="00000000-0000-0000-0000-000000000000" />
      </label>
      <div class="grid grid-cols-2 gap-3">
        <label class="block text-sm">Tenant
          <select id="tenant" class="mt-1 w-full px-3 py-2 border rounded-xl">
            <option value="common">common (varsayılan)</option>
            <option value="organizations">organizations</option>
            <option value="consumers">consumers (kişisel Microsoft hesabı)</option>
          </select>
        </label>
        <label class="block text-sm">Redirect URI
          <input id="redirectUri" class="mt-1 w-full px-3 py-2 border rounded-xl" />
        </label>
      </div>
      <p class="text-xs text-gray-600">Gerekli yetkiler: <span class="mono">openid profile offline_access Mail.ReadWrite</span>. İlk kullanımda onay istenir.</p>
      <div class="text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded-xl p-2">
        <b>Uyarı:</b> Bu araç e-postaları silebilir/taşıyabilir. Önce <i>"Çöp Kutusuna Taşı"</i> modunda test edin.
      </div>
    </div>
  </div>

  <!-- Rules Card -->
  <div class="bg-white rounded-2xl shadow p-4 sm:p-6">
    <h2 class="text-lg font-semibold mb-3">2) Kurallar (Anahtar Kelime Listesi)</h2>
    <label class="block text-sm">Her satıra bir kelime/ifade (büyük-küçük harf fark etmez)
      <textarea id="keywords" class="mt-1 w-full h-40 px-3 py-2 border rounded-xl" placeholder="sleep gummies\nloan\ncarshield\nRenewal by Andersen\n...">sleep gummies

loan carshield Renewal by Andersen depo-provera Ethena Titan Home Roofing </textarea> </label> <div class="mt-3 grid sm:grid-cols-2 gap-3"> <label class="flex items-center gap-2 text-sm"> <input id="useRegex" type="checkbox" class="scale-110" /> İfadeleri <b>RegExp</b> olarak yorumla </label> <label class="flex items-center gap-2 text-sm"> <input id="searchBody" type="checkbox" class="scale-110" checked /> Konuya ek olarak <b>gövde metninde</b> de ara </label> </div> </div> </section>

<section class="mt-4 grid md:grid-cols-2 gap-4">
  <!-- Scope Card -->
  <div class="bg-white rounded-2xl shadow p-4 sm:p-6">
    <h2 class="text-lg font-semibold mb-3">3) Kapsam & Güvenlik</h2>
    <div class="space-y-2">
      <label class="flex items-center gap-2 text-sm">
        <input id="includeSent" type="checkbox" class="scale-110" />
        <span><b>Gönderilmiş Öğeler</b> ve <b>Taslaklar</b> da taransın</span>
      </label>
      <label class="flex items-center gap-2 text-sm">
        <input id="includeDeleted" type="checkbox" class="scale-110" />
        <span><b>Silinmiş Öğeler</b> de taransın</span>
      </label>
      <label class="block text-sm">Hariç tutulacak klasör adları (virgülle)
        <input id="excludeFolders" class="mt-1 w-full px-3 py-2 border rounded-xl" placeholder="Ör: Archive, Projects" value="Archive" />
      </label>
      <div class="grid grid-cols-2 gap-3">
        <label class="block text-sm">Silme Yöntemi
          <select id="deleteMode" class="mt-1 w-full px-3 py-2 border rounded-xl">
            <option value="soft">Çöp Kutusuna Taşı (önerilir)</option>
            <option value="hard">Kalıcı Sil (geri alınamaz)</option>
          </select>
        </label>
        <label class="block text-sm">Sayfa Boyutu (performans)
          <input id="pageSize" type="number" min="10" max="1000" step="10" value="100" class="mt-1 w-full px-3 py-2 border rounded-xl" />
        </label>
      </div>
    </div>
  </div>

  <!-- Automation Card -->
  <div class="bg-white rounded-2xl shadow p-4 sm:p-6">
    <h2 class="text-lg font-semibold mb-3">4) Çalıştırma</h2>
    <div class="flex items-center gap-3">
      <button id="scanBtn" class="px-4 py-2 rounded-2xl bg-black text-white disabled:opacity-50" disabled>
        Tüm Klasörleri Tara & Uygula
      </button>
      <div id="busy" class="hidden spinner"></div>
    </div>
    <div class="mt-3 flex items-center gap-2 text-sm">
      <label class="flex items-center gap-2">
        <input id="autoScanToggle" type="checkbox" class="scale-110" />
        Otomatik tarama (sekme açıkken)
      </label>
      <input id="autoScanMinutes" type="number" min="1" value="10" class="w-20 px-3 py-2 border rounded-xl" />
      <span>dakikada bir</span>
    </div>
    <p class="mt-2 text-xs text-gray-600">Not: Tamamen tarayıcı tarafında çalışır; arka planda/sistem servisinde çalışmaz. Sekme açıkken periyodik tarama yapılabilir.</p>
  </div>
</section>

<!-- Logs -->
<section class="mt-6 bg-white rounded-2xl shadow p-4 sm:p-6">
  <div class="flex items-center justify-between">
    <h2 class="text-lg font-semibold">Günlük (Log)</h2>
    <button id="clearLog" class="text-sm px-3 py-1 rounded-xl bg-gray-100">Temizle</button>
  </div>
  <pre id="log" class="mt-3 bg-gray-50 p-3 rounded-xl h-64 overflow-auto mono text-sm"></pre>
  <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
    <div class="p-3 bg-gray-50 rounded-xl"><b>Tarama:</b> <span id="statScans">0</span></div>
    <div class="p-3 bg-gray-50 rounded-xl"><b>Eşleşme:</b> <span id="statMatches">0</span></div>
    <div class="p-3 bg-gray-50 rounded-xl"><b>Taşınan/Silinen:</b> <span id="statDeleted">0</span></div>
    <div class="p-3 bg-gray-50 rounded-xl"><b>Hatalar:</b> <span id="statErrors">0</span></div>
  </div>
</section>

<footer class="mt-8 text-xs text-gray-500">
  <p>© 2025 — Yalnızca kişisel kullanım içindir. Microsoft Graph kotaları ve arama sınırlamaları geçerlidir.</p>
</footer>

  </div>  <script>
    // ===== Utility: simple logger & stats =====
    const logEl = document.getElementById('log');
    const stat = { scans: 0, matches: 0, deleted: 0, errors: 0 };
    const setStat = () => {
      document.getElementById('statScans').textContent = stat.scans;
      document.getElementById('statMatches').textContent = stat.matches;
      document.getElementById('statDeleted').textContent = stat.deleted;
      document.getElementById('statErrors').textContent = stat.errors;
    };
    const log = (msg) => {
      const ts = new Date().toLocaleString();
      logEl.textContent += [${ts}] ${msg}\n;
      logEl.scrollTop = logEl.scrollHeight;
    };
    document.getElementById('clearLog').addEventListener('click', ()=>{ logEl.textContent=''; });

    // ===== MSAL & Graph setup =====
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const scanBtn = document.getElementById('scanBtn');
    const busy = document.getElementById('busy');

    const clientIdInput = document.getElementById('clientId');
    const tenantSelect = document.getElementById('tenant');
    const redirectUriInput = document.getElementById('redirectUri');

    const requiredScopes = ["openid", "profile", "offline_access", "Mail.ReadWrite"];
    let msalApp = null; // PublicClientApplication
    let account = null;

    function ensureMsal() {
      const clientId = clientIdInput.value.trim();
      const tenant = tenantSelect.value;
      let redirectUri = redirectUriInput.value.trim();
      if (!redirectUri) { redirectUri = window.location.origin + window.location.pathname; redirectUriInput.value = redirectUri; }
      if (!clientId) { alert('Lütfen Client ID girin.'); throw new Error('Missing clientId'); }
      const authority = https://login.microsoftonline.com/${tenant};
      const config = { auth: { clientId, authority, redirectUri }, cache: { cacheLocation: 'localStorage', storeAuthStateInCookie: false } };
      if (!msalApp) {
        msalApp = new msal.PublicClientApplication(config);
        msalApp.handleRedirectPromise().then((res)=>{
          if (res && res.account) { account = res.account; log(Oturum açıldı: ${account.username}); updateAuthUI(true); }
        }).catch(err => { log(MSAL redirect hatası: ${err.message}); stat.errors++; setStat(); });
      }
      return msalApp;
    }

    function updateAuthUI(isAuthed) {
      loginBtn.disabled = isAuthed;
      logoutBtn.disabled = !isAuthed;
      scanBtn.disabled = !isAuthed;
    }

    async function login() {
      try {
        ensureMsal();
        const res = await msalApp.loginPopup({ scopes: requiredScopes });
        account = res.account;
        log(Oturum açıldı: ${account.username});
        updateAuthUI(true);
      } catch (e) {
        log(Giriş hatası: ${e.message}); stat.errors++; setStat();
      }
    }

    async function logout() {
      if (!msalApp || !account) return;
      try {
        await msalApp.logoutPopup({ account });
        account = null;
        updateAuthUI(false);
        log('Çıkış yapıldı.');
      } catch (e) {
        log(Çıkış hatası: ${e.message}); stat.errors++; setStat();
      }
    }

    async function getToken() {
      ensureMsal();
      if (!account) {
        const accts = msalApp.getAllAccounts();
        if (accts.length) { account = accts[0]; }
      }
      const request = { scopes: requiredScopes, account };
      try {
        const res = await msalApp.acquireTokenSilent(request);
        return res.accessToken;
      } catch (e) {
        const res = await msalApp.acquireTokenPopup(request);
        return res.accessToken;
      }
    }

    // ===== Microsoft Graph helpers =====
    async function graphFetch(path, opts = {}) {
      const token = await getToken();
      const base = 'https://graph.microsoft.com/v1.0';
      const headers = Object.assign({
        'Authorization': Bearer ${token},
        'Accept': 'application/json',
      }, opts.headers || {});
      const res = await fetch(base + path, { ...opts, headers });
      if (res.status === 429 || res.status === 503) {
        const retryAfter = parseInt(res.headers.get('Retry-After') || '3', 10) * 1000;
        log(Oran sınırı, ${retryAfter/1000}s sonra tekrar denenecek: ${path});
        await new Promise(r => setTimeout(r, retryAfter));
        return graphFetch(path, opts);
      }
      if (!res.ok) {
        const text = await res.text();
        throw new Error(Graph hata ${res.status}: ${text});
      }
      return res.json();
    }

    async function graphFetchRaw(path, opts = {}) {
      const token = await getToken();
      const base = 'https://graph.microsoft.com/v1.0';
      const headers = Object.assign({ 'Authorization': Bearer ${token} }, opts.headers || {});
      const res = await fetch(base + path, { ...opts, headers });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(Graph hata ${res.status}: ${text});
      }
      return res;
    }

    async function listAllMailFolders() {
      const includeSent = document.getElementById('includeSent').checked;
      const includeDeleted = document.getElementById('includeDeleted').checked;
      const exclude = (document.getElementById('excludeFolders').value || '')
        .split(',').map(s => s.trim().toLowerCase()).filter(Boolean);

      let url = /me/mailFolders?$top=50;
      const all = [];
      while (url) {
        const data = await graphFetch(url);
        (data.value || []).forEach(f => { all.push(f); });
        url = (data['@odata.nextLink'] || '').replace('https://graph.microsoft.com/v1.0', '');
      }
      // Filter
      const filtered = all.filter(f => {
        const name = (f.displayName || '').toLowerCase();
        if (!includeSent && (name === 'sent items' || name === 'drafts')) return false;
        if (!includeDeleted && (name === 'deleted items')) return false;
        if (exclude.includes(name)) return false;
        return true;
      });
      return filtered;
    }

    function buildSearchQuery(keywords) {
      // Build a $search string: \"k1\" OR \"k2\"
      const terms = keywords.map(k => \"${k.replace(/\"/g,'')}\").join(' OR ');
      return terms || '';
    }

    function normalizeKeywords() {
      let lines = (document.getElementById('keywords').value || '').split(/\n+/)
        .map(s => s.trim()).filter(Boolean);
      // dedupe, lowercase for contains check
      const seen = new Set();
      lines = lines.filter(l => { const key = l.toLowerCase(); if (seen.has(key)) return false; seen.add(key); return true; });
      return lines;
    }

    function messageMatches(msg, keywords, useRegex, searchBody) {
      const hay = ((msg.subject || '') + '\n' + (searchBody ? (msg.bodyPreview || '') : '')).toLowerCase();
      try {
        if (useRegex) {
          return keywords.some(p => new RegExp(p, 'i').test(hay));
        } else {
          return keywords.some(k => hay.includes(k.toLowerCase()));
        }
      } catch (e) {
        log('Regex hatası: ' + e.message);
        stat.errors++; setStat();
        return false;
      }
    }

    async function moveToDeleted(messageId) {
      // Move action keeps recoverability
      const body = JSON.stringify({ destinationId: 'DeletedItems' });
      await graphFetch(/me/messages/${messageId}/move, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body });
    }

    async function hardDelete(messageId) {
      await graphFetchRaw(/me/messages/${messageId}, { method: 'DELETE' });
    }

    async function processFolder(folder) {
      const pageSize = Math.max(10, Math.min(1000, parseInt(document.getElementById('pageSize').value || '100', 10)));
      const keywords = normalizeKeywords();
      const useRegex = document.getElementById('useRegex').checked;
      const searchBody = document.getElementById('searchBody').checked;
      const deleteMode = document.getElementById('deleteMode').value;

      log(Klasör taranıyor: ${folder.displayName} (id: ${folder.id}));

      // Try server-side $search to reduce traffic (needs ConsistencyLevel: eventual)
      // Then client-side confirm against subject/bodyPreview
      let url = /me/mailFolders/${folder.id}/messages?$top=${pageSize}&$select=id,subject,bodyPreview&$orderby=receivedDateTime desc;

      // $search is only available on specific endpoints; add when we have terms
      const searchTerms = buildSearchQuery(keywords);
      const useServerSearch = Boolean(searchTerms);

      while (url) {
        try {
          const opts = useServerSearch ? { headers: { 'ConsistencyLevel': 'eventual' } } : {};
          const data = await graphFetch(url + (useServerSearch ? &$search=${encodeURIComponent(searchTerms)} : ''), opts);
          const items = data.value || [];
          for (const msg of items) {
            if (messageMatches(msg, keywords, useRegex, searchBody)) {
              stat.matches++; setStat();
              try {
                if (deleteMode === 'hard') { await hardDelete(msg.id); }
                else { await moveToDeleted(msg.id); }
                stat.deleted++; setStat();
                log(Silindi/Taşındı: ${msg.subject || '(no subject)'} (${msg.id}));
              } catch (e) {
                stat.errors++; setStat();
                log(Silme hatası: ${e.message});
              }
            }
          }
          url = (data['@odata.nextLink'] || '').replace('https://graph.microsoft.com/v1.0', '');
        } catch (e) {
          stat.errors++; setStat();
          log(Klasör hatası (${folder.displayName}): ${e.message});
          break; // move to next folder
        }
      }
    }

    async function scanAll() {
      stat.scans++; setStat();
      busy.classList.remove('hidden');
      scanBtn.disabled = true;
      try {
        const folders = await listAllMailFolders();
        for (const f of folders) {
          await processFolder(f);
        }
        log('Tarama bitti.');
      } catch (e) {
        stat.errors++; setStat();
        log('Genel hata: ' + e.message);
      } finally {
        scanBtn.disabled = false;
        busy.classList.add('hidden');
      }
    }

    // Auto-scan timer (only while tab is open)
    let autoTimer = null;
    function setAutoScan(enabled) {
      const mins = Math.max(1, parseInt(document.getElementById('autoScanMinutes').value || '10', 10));
      if (enabled) {
        if (autoTimer) clearInterval(autoTimer);
        autoTimer = setInterval(scanAll, mins * 60 * 1000);
        log(Otomatik tarama aktif: her ${mins} dakikada bir.);
      } else {
        if (autoTimer) clearInterval(autoTimer);
        autoTimer = null;
        log('Otomatik tarama kapalı.');
      }
    }

    // Wire UI
    loginBtn.addEventListener('click', login);
    logoutBtn.addEventListener('click', logout);
    scanBtn.addEventListener('click', scanAll);
    document.getElementById('autoScanToggle').addEventListener('change', (e)=> setAutoScan(e.target.checked));

    // Prefill redirect URI on load
    redirectUriInput.value = window.location.origin + window.location.pathname;
    updateAuthUI(false);
  </script></body>
</html>